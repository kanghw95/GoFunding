<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="User">
	<resultMap type="User" id="resultUser">
		<id property="userId" column="id" />
		<result property="userPwd" column="pwd" />
		<result property="userName" column="name" />
		<result property="userNick" column="nickname" />
		<result property="userPhone" column="phone" />
		<result property="userAddress" column="address" />
		<result property="userEmail" column="email" />
		<result property="gender" column="gender" />
		<result property="userAge" column="age" />
		<result property="userFav" column="fav" />
		<result property="point" column="point" />
		<result property="authority" column="authority" /> 
		<result property="suspensionStart" column="suspensionstart" /> 
		<result property="suspensionFin" column="suspensionfin" /> 
		<result property="reportCnt" column="reportcnt" /> 
		<result property="joinDate" column="joindate"/>
		<result property="loginDate" column="logindate"/>
	</resultMap>
	
		
	<!-- 마이페이지 펀딩 JOIN -->	
	<resultMap type="MyFunding" id="resultMyFunding">
		<result property="orderNo" column="ORDERNO" />
		<result property="orderDetailNo" column="ORDERDETAILNO" />
		<result property="orderStatus" column="ORDERSTATUS" />
		<result property="fundingNo" column="FUNDINGNO" />
		<result property="userId" column="ID" />
		<result property="fundingTitle" column="FUNDINGTITLE" />
		<result property="maker" column="MAKER" />
		<result property="orderDate" column="ORDERDATE" />
		<result property="rewardTitle" column="REWARDTITLE" />
		<result property="rewardPrice" column="REWARDPRICE" />
		<result property="rewardCount" column="REWARDCOUNT" />
		<result property="rTotalPrice" column="RTOTALPRICE" />
		<result property="fundingstart" column="FUNDINGSTRAT" />
		<result property="fundingfin" column="FUNDINGFIN" />
	</resultMap>

		
	<!-- 회원가입 -->
	<insert id="insertUser" parameterType="User">
		<![CDATA[
		INSERT INTO USERS 
		(ID, PWD, NAME, NICKNAME, PHONE, ADDRESS, EMAIL, GENDER, AGE, FAV, JOINDATE, LOGINDATE)
		VALUES 
		(#{userId}, #{userPwd}, #{userName}, #{userNick}, #{userPhone}, #{userAddress}, #{userEmail}, #{gender}, #{userAge}, #{userFav}, SYSDATE, SYSDATE)
		]]>
	</insert>
	
	<!-- id 중복체크 -->
	<select id="idCheck" parameterType="string" resultType="int">
		SELECT count(*) FROM USERS WHERE id = #{userId}
	</select>
	
	<!-- nickname 중복체크 -->
	<select id="nickCheck" parameterType="string" resultType="int">
		SELECT count(*) FROM USERS WHERE nickname = #{userNick}
	</select>
	
	<!-- email 중복체크 -->
	<select id="emailCheck" parameterType="string" resultType="int">
		SELECT count(*) FROM USERS WHERE email = #{userEmail}
	</select>
	
	<!-- 로그인 -->
	<select id="logIn" parameterType="string" resultMap="resultUser">
		SELECT * FROM USERS WHERE ID = #{userId} AND PWD = #{userPwd}
	</select>
	
	<!-- 소셜로그인 -->
	<select id="socialLogIn" parameterType="string" resultMap="resultUser">
		SELECT * FROM USERS WHERE NAME = #{userName} AND EMAIL = #{userEmail}
	</select>
	
	<!-- 아이디 찾기 -->
	<select id="findId" parameterType="string" resultMap="resultUser">
		SELECT ID FROM USERS WHERE NAME = #{userName} AND EMAIL = #{userEmail} AND PHONE = #{userPhone}
	</select>
	
	<!-- 비밀번호 찾기 -->
	<select id="findPwd" parameterType="string" resultMap="resultUser">
		SELECT PWD FROM USERS WHERE ID = #{userId} AND EMAIL = #{userEmail} AND PHONE = #{userPhone}
	</select>
	
	<!-- 회원 탈퇴 -->
	<delete id="deleteUser" parameterType="string">
		DELETE FROM USERS WHERE ID = #{userId}	
	</delete>
	
	<!-- 회원 탈퇴 정보 저장 -->
	
	
	<!-- 내가 참여한 펀딩 전체 -->
	<select id="myFunding" parameterType="string" resultType="myFunding">
		<![CDATA[
			SELECT O.ORDERNO, F.FUNDINGNO, O.ID, F.FUNDINGTITLE, F.MAKER, O.ORDERDATE
			FROM FUNDING F JOIN ORDERS O
			ON F.FUNDINGNO = O.FUNDINGNO
			WHERE O.ID = #{userId}
			ORDER BY ORDERDATE
		]]>
	</select>
	
	<!-- 내가 참여한 펀딩 -->
	<select id="myFundingDetail" parameterType="myFunding" resultType="myFunding">
		<![CDATA[
			SELECT O.ORDERNO, F.FUNDINGNO, O.ID, F.FUNDINGTITLE, F.MAKER, O.ORDERDATE
			FROM FUNDING F JOIN ORDERS O
			ON F.FUNDINGNO = O.FUNDINGNO
			WHERE O.ID = #{userId} AND F.FUNDINGNO = #{fundingNo}
			ORDER BY ORDERDATE
		]]>
	</select>
	
	<!-- 내가 참여한 펀딩 수 -->
	<select id="cntMyFunding" parameterType="string" resultType="int">
		SELECT COUNT(*) FROM ( 
			SELECT F.FUNDINGTITLE, F.MAKER, O.ORDERDATE, O.ID
			FROM FUNDING F JOIN ORDERS O
			ON F.FUNDINGNO = O.FUNDINGNO
			WHERE O.ID = #{userId})
	</select>
	
	<!-- 내가 참여한 펀딩 상세 -->
	<select id="myFundingReward" parameterType="string" resultType="myFunding">
		<![CDATA[
			SELECT B.FUNDINGNO, R.REWARDTITLE, R.REWARDPRICE, B.REWARDCOUNT, B.REWARDPRICE AS RTOTALPRICE, B.ORDERNO, B.ORDERDETAILNO, B.ORDERSTATUS 
			FROM REWARD R JOIN (
			    SELECT O.FUNDINGNO, O.ID, D.REWARDNO, D.REWARDPRICE, D.REWARDCOUNT, D.ORDERNO, D.ORDERDETAILNO, D.ORDERSTATUS
			    FROM ORDERS O JOIN ORDERSDETAIL D
			    ON O.ORDERNO = D.ORDERNO
			    WHERE O.ID = #{userId}
			    ) B
			ON R.REWARDNO = B.REWARDNO	
		]]>
	</select>
	
	<!-- 펀딩신청서 저장 -->
	<insert id="inputForm">
		INSERT INTO APPLICATION VALUES (SEQ_APPLYNO.NEXTVAL, #{maker}, #{description}, #{id}, #{makerTel},
		#{makerEmail}, #{makerInfo}, #{fundingTitle}, #{fundingCategory}, #{fundingContent}, #{fundingPrice},
		#{fundingStart}, #{fundingFin}, #{fundingPlan}, #{rewardDesc}, #{rewardPrice}, #{rewardTitle}, #{rewardEA}, null,
		#{deliveryCharge}, #{deliveryDate}, #{makerName})
		</insert>
	
	<!-- 메이커명 중복체크 -->
	<select id="makerChk" parameterType="string" resultType="java.lang.String">
		SELECT MAKER FROM MAKER WHERE MAKER = #{maker}
	</select>
	
</mapper>
